<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Casamento Eduardo & Amanda</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, #f7f4ff, #ffffff);
  color: #444;
  text-align: center;
  padding: 20px;
}
.container { max-width: 480px; margin: auto; }
h1 { color: #6a4bc3; }
p { font-size: 16px; line-height: 1.5; }
.hidden { display: none; }
video, img { width: 100%; border-radius: 12px; margin-top: 15px; }
button {
  width: 100%;
  padding: 16px;
  margin-top: 12px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  transition: transform 0.1s ease;
}
button:active { transform: scale(0.97); }
.start { background: #6a4bc3; color: #fff; }
.send { background: #2e7d32; color: #fff; }
.retry { background: #e0e0e0; }
.stop { background: #d32f2f; color: #fff; }
.recording-indicator {
  display: inline-block;
  width: 12px;
  height: 12px;
  background: red;
  border-radius: 50%;
  margin-right: 8px;
  animation: blink 1s infinite;
  vertical-align: middle;
}
@keyframes blink {
  0%, 50%, 100% { opacity: 1; }
  25%, 75% { opacity: 0; }
}
#timer { font-weight: bold; font-size: 18px; color: #d32f2f; }
.success { margin-top: 30px; font-size: 20px; color: #2e7d32; transition: all 0.5s ease; opacity: 0; }
.success.show { opacity: 1; transform: translateY(0); }
</style>
</head>

<body>
<div class="container">

<!-- BOAS-VINDAS -->
<div id="welcome">
  <h1>ğŸ’ Eduardo & Amanda</h1>
  <p>
    Obrigado por celebrar conosco â¤ï¸<br>
    Clique no botÃ£o abaixo para tirar sua foto ou gravar seu vÃ­deo!
  </p>
  <button id="startCamera" class="start">ğŸ“¸ ComeÃ§ar</button>
</div>

<!-- ESCOLHA DE CÃ‚MERA -->
<div id="cameraChoice" class="hidden">
  <p>Escolha a cÃ¢mera:</p>
  <button onclick="abrirCamera('user')">ğŸ“· Frontal</button>
  <button onclick="abrirCamera('environment')">ğŸ“¸ Traseira</button>
</div>

<!-- VISUALIZAÃ‡ÃƒO DA CÃ‚MERA -->
<div id="cameraContainer" class="hidden">
  <video id="cameraVideo" autoplay playsinline muted></video>
  <div id="cameraActions">
    <button id="takePhotoButton">ğŸ“¸ Tirar Foto</button>
    <button id="startRecordingButton">ğŸ¥ Gravar VÃ­deo</button>
    <button onclick="cancelarCamera()">âŒ Cancelar</button>
  </div>
  <div id="recordingStatus" class="hidden">
    <span class="recording-indicator"></span> Gravando... <span id="timer">15</span>s
    <button id="stopRecordingButton" class="stop">â¹ï¸ Parar</button>
  </div>
</div>

<!-- PRÃ‰-VISUALIZAÃ‡ÃƒO -->
<div id="previewContainer" class="hidden">
  <div id="preview"></div>
  <div id="actions" class="hidden">
    <button id="sendButton" class="send">ğŸ“¤ Enviar</button>
    <button type="button" class="retry" onclick="resetar()">ğŸ”„ Refazer</button>
  </div>
</div>

<!-- SUCESSO -->
<div id="success" class="success">
  âœ… <strong>SALVO E ENVIADO!</strong><br><br>
  Muito obrigado por compartilhar esse momento especial ğŸ’–<br>
  Sua foto jÃ¡ pode aparecer na TV!
</div>

</div>

<script>
let stream;
let mediaRecorder;
let recordedChunks = [];
let mediaBlob;
const maxVideoTime = 15; // segundos
let recordingTimer;
let timeLeft = maxVideoTime;

const startButton = document.getElementById("startCamera");
const cameraChoice = document.getElementById("cameraChoice");
const cameraContainer = document.getElementById("cameraContainer");
const cameraVideo = document.getElementById("cameraVideo");
const previewContainer = document.getElementById("previewContainer");
const preview = document.getElementById("preview");
const actions = document.getElementById("actions");
const success = document.getElementById("success");
const takePhotoButton = document.getElementById("takePhotoButton");
const startRecordingButton = document.getElementById("startRecordingButton");
const stopRecordingButton = document.getElementById("stopRecordingButton");
const recordingStatus = document.getElementById("recordingStatus");
const timerElement = document.getElementById("timer");

// Fluxo inicial
startButton.onclick = () => {
  document.getElementById("welcome").classList.add("hidden");
  cameraChoice.classList.remove("hidden");
};

// Abrir cÃ¢mera (corrigido para evitar travamento)
async function abrirCamera(facingMode) {
  cameraChoice.classList.add("hidden");
  cameraContainer.classList.remove("hidden");

  try {
    // Captura vÃ­deo + Ã¡udio apÃ³s clique do usuÃ¡rio
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: facingMode }, 
      audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
    });

    // Stream apenas de vÃ­deo para exibiÃ§Ã£o (garante autoplay sem travar)
    const videoOnlyStream = new MediaStream(stream.getVideoTracks());
    cameraVideo.srcObject = videoOnlyStream;
    cameraVideo.muted = true;
    cameraVideo.play().catch(err => console.log("VÃ­deo nÃ£o reproduziu automaticamente:", err));

  } catch (err) {
    console.error(err);
    alert("NÃ£o foi possÃ­vel acessar a cÃ¢mera. Por favor, permita o acesso e tente novamente.");
    location.reload();
  }
}

// Cancelar cÃ¢mera â†’ recarregar
function cancelarCamera() {
  stopStream();
  location.reload();
}

// Parar stream da cÃ¢mera
function stopStream() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
}

// Tirar foto
takePhotoButton.onclick = () => {
  const canvas = document.createElement("canvas");
  canvas.width = cameraVideo.videoWidth;
  canvas.height = cameraVideo.videoHeight;
  canvas.getContext("2d").drawImage(cameraVideo, 0, 0);

  canvas.toBlob(blob => {
    mediaBlob = blob;
    const img = document.createElement("img");
    img.src = URL.createObjectURL(blob);
    mostrarPreview(img);
  }, "image/png");

  stopStream();
}

// Iniciar gravaÃ§Ã£o
startRecordingButton.onclick = () => {
  recordedChunks = [];
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) recordedChunks.push(e.data);
  };
  mediaRecorder.onstop = () => {
    mediaBlob = new Blob(recordedChunks, { type: "video/webm" });
    const video = document.createElement("video");
    video.src = URL.createObjectURL(mediaBlob);
    video.controls = true;
    mostrarPreview(video);
  };

  mediaRecorder.start();
  startRecordingButton.disabled = true;
  takePhotoButton.disabled = true;
  recordingStatus.classList.remove("hidden");
  timeLeft = maxVideoTime;
  timerElement.textContent = timeLeft;

  recordingTimer = setInterval(() => {
    timeLeft--;
    timerElement.textContent = timeLeft;
    if (timeLeft <= 0) stopRecording();
  }, 1000);
}

// Parar gravaÃ§Ã£o manual ou quando acabar o tempo
stopRecordingButton.onclick = stopRecording;

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    clearInterval(recordingTimer);
    recordingStatus.classList.add("hidden");
    startRecordingButton.disabled = false;
    takePhotoButton.disabled = false;
    stopStream();
  }
}

// Mostrar prÃ©-visualizaÃ§Ã£o
function mostrarPreview(mediaElement) {
  cameraContainer.classList.add("hidden");
  previewContainer.classList.remove("hidden");
  preview.innerHTML = "";
  preview.appendChild(mediaElement);
  actions.classList.remove("hidden");
}

// Resetar tudo
function resetar() {
  mediaBlob = null;
  preview.innerHTML = "";
  actions.classList.add("hidden");
  previewContainer.classList.add("hidden");
  cameraContainer.classList.add("hidden");
  cameraChoice.classList.remove("hidden");
}

// Envio real para Formsubmit
document.getElementById("sendButton").onclick = async () => {
  if (!mediaBlob) return alert("Nenhuma mÃ­dia para enviar.");

  const formData = new FormData();
  formData.append("arquivo", mediaBlob, mediaBlob.type.startsWith("image") ? "foto.png" : "video.webm");
  formData.append("_captcha", "false");
  formData.append("_subject", "Casamento Eduardo & Amanda - MÃ­dia enviada");

  try {
    await fetch("https://formsubmit.co/eduardo.goncalves27@gmail.com", {
      method: "POST",
      body: formData
    });
    previewContainer.classList.add("hidden");
    actions.classList.add("hidden");
    success.classList.add("show");
    setTimeout(() => location.reload(), 2000);
  } catch (err) {
    alert("Erro ao enviar. Tente novamente.");
  }
};
</script>
</body>
</html>
